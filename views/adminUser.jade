doctype 5
html
	include includes/head_meta
		script(type='text/javascript', src="/js/knockout-2.1.0.js")
		script(type='text/javascript', src="/js/knockout.mapping-latest.js")
		script(type='text/javascript', src="/js/mvvm/User.js")
		script(type='text/javascript', src="/js/mvvm/TopPanel.js")

		script(type='text/javascript').
			var socket,
				iAmVM;
				
			var GlobalParams = {
					Width: Utils.getClientWidth(),
					Height: Utils.getClientHeight(),
					
					USE_OSM_API: true,
					USE_GOOGLE_API: true,
					USE_YANDEX_API: true,
					appVersion: 0,
					verBuild: 0,
					
					REGISTRATION_ALLOWED: false,
					LoggedIn: false
				},
				GlobalParamsVM;	
			function GlobalParamsToKO(){
				if (!GlobalParamsVM) GlobalParamsVM = ko.mapping.fromJS(GlobalParams);
				else ko.mapping.fromJS(GlobalParams, GlobalParamsVM);
			}
			
			var i18n = {
				en : {
					login : 'Login',
					logout : 'Logout',
					register : 'Registration',
					admin : 'Administration'
				},
				ru : {
				}
			};
			var i18nVM;
			function i18nToKO(lang){
				if (!i18nVM) i18nVM = ko.mapping.fromJS(i18n[lang]);
				else ko.mapping.fromJS(i18n[lang], i18nVM);
			}
			function Logout(){
				socket.on('logoutResult', function (json) {
					if (json.err){
						consol.log('Logout error' + json.err);
					}else {
						document.location = json.logoutPath;
					}
					
				});
				socket.emit('logoutRequest', {});
				return false;
			}
			$(document).ready(function() {
				i18nToKO('en');
				socket = io.connect(location.host);
				socket.on('connect', function () {
					socket.on('initMessage', function (json) {
						var init_message = json.init_message;
					});
					
					socket.on('youAre', function (user) {
						console.dir(user);
						GlobalParams.LoggedIn = !!user;
						GlobalParamsToKO();
						iAmVM = UserUpdate(user, iAmVM);
						
						CreateTopPanelVM();
						BindTopPanelVM();
					});
					socket.emit('whoAmI', {});
				});
			});
	body
		include includes/top