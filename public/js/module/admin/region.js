/*global define:true*/

/**
 * Модель создания/редактирования новости
 */
define([
	'underscore', 'jquery', 'Utils', 'socket!', 'Params', 'knockout', 'knockout.mapping', 'm/_moduleCliche', 'globalVM',
	'leaflet', 'model/storage',
	'text!tpl/admin/region.jade', 'css!style/admin/region', 'css!style/leaflet'
], function (_, $, Utils, socket, P, ko, ko_mapping, Cliche, globalVM, L, storage, jade) {
	'use strict';

	var regionDef = {
			cid: 0,
			parent: undefined,
			geo: '',
			level: 0,
			title_en: '',
			title_local: ''
		},
		OSM_ANDORRA_GEOJSON = ({"type":"MultiPolygon","coordinates":[[[[1.4135847,42.535374699999998],[1.4138791,42.536012399999997],[1.4139407,42.536774399999999],[1.4142155,42.5374914],[1.4143211,42.537886800000003],[1.4143794,42.540073700000001],[1.415008,42.540754300000003],[1.4153617,42.541138699999998],[1.4160847,42.541902499999999],[1.4164394,42.5423197],[1.4168127,42.542892399999999],[1.4173735,42.5435911],[1.4185402,42.544077199999997],[1.4188136,42.544327799999998],[1.4191705,42.545070299999999],[1.4194324,42.545330300000003],[1.4192558,42.5469668],[1.4190286,42.548781400000003],[1.4192789,42.549531999999999],[1.4194546,42.549606199999999],[1.4205264,42.549780900000002],[1.4208081,42.5499771],[1.4208617,42.550218100000002],[1.4212903,42.550939900000003],[1.4223015,42.552152300000003],[1.4225976,42.553239300000001],[1.422795,42.553618800000002],[1.4230386,42.555486600000002],[1.4237033,42.556216499999998],[1.4245008,42.557011299999999],[1.4252275,42.557961599999999],[1.4264338,42.558529700000001],[1.4279867,42.559070499999997],[1.4307507,42.560541000000001],[1.4348453,42.56212],[1.4366683,42.563093799999997],[1.4370659,42.563204399999996],[1.4376553,42.5632716],[1.4400608,42.563871499999998],[1.4410913,42.564317699999997],[1.4421754,42.565361600000003],[1.443427,42.566623499999999],[1.4443594,42.5672426],[1.444442,42.567831499999997],[1.4443374,42.568652299999997],[1.4438994,42.569370499999998],[1.4435478,42.570258600000003],[1.4435813,42.571349099999999],[1.4434009,42.571923499999997],[1.4412462,42.572612399999997],[1.4377075,42.5732608],[1.4344062,42.574267300000002],[1.432461,42.575285399999999],[1.4312173,42.576804799999998],[1.4283011,42.580078399999998],[1.4266614,42.583073200000001],[1.4274737,42.584920400000001],[1.4274448,42.586726599999999],[1.4281649,42.587725599999999],[1.4312355,42.587997899999998],[1.4346474,42.590418],[1.4358685,42.591677300000001],[1.4375964,42.5917861],[1.4383921,42.592296599999997],[1.4405939,42.594439800000004],[1.4405211,42.594833600000001],[1.4408335,42.596121799999999],[1.4415511,42.597332999999999],[1.4421881,42.598394200000001],[1.4428035,42.598759000000001],[1.4427787,42.599857700000001],[1.4429107,42.6015011],[1.4426756,42.602755799999997],[1.4419886,42.603720000000003],[1.4433331,42.603527800000002],[1.4456716,42.603525599999998],[1.447125,42.603733599999998],[1.4481871,42.6036006],[1.4509584,42.6023687],[1.4527676,42.602462000000003],[1.4541149,42.602560799999999],[1.4561692,42.602027800000002],[1.4587379,42.603332299999998],[1.4596181,42.605300100000001],[1.4616761,42.6065021],[1.4689753,42.606462999999998],[1.4704844,42.608964],[1.4728722,42.610094199999999],[1.4748768,42.611699600000001],[1.474871,42.612451499999999],[1.4755831,42.612762400000001],[1.4766019,42.613081700000002],[1.4768834,42.613459300000002],[1.4775431,42.614640299999998],[1.4759742,42.616432500000002],[1.4750056,42.618032300000003],[1.4744002,42.619980099999999],[1.4735591,42.622062],[1.4725685,42.622666299999999],[1.472077,42.6237578],[1.470936,42.624806200000002],[1.4705824,42.626054699999997],[1.471316,42.628242800000002],[1.4711014,42.629406600000003],[1.4680158,42.630989],[1.4694584,42.633845299999997],[1.4700246,42.635638899999996],[1.4709365,42.636095599999997],[1.4716613,42.636860300000002],[1.4734977,42.637777100000001],[1.4768675,42.640601799999999],[1.4777379,42.642333100000002],[1.4780969,42.643534899999999],[1.4769565,42.644549099999999],[1.4770224,42.645648000000001],[1.4781124,42.646692000000002],[1.4787141,42.648690299999998],[1.4787773,42.651449800000002],[1.4870487,42.651924000000001],[1.4930958,42.653449000000002],[1.4966068,42.649971000000001],[1.4993566,42.645937099999998],[1.5012149,42.645476100000003],[1.5064888,42.6454308],[1.5121761,42.646026200000001],[1.5170458,42.645859199999997],[1.5191018,42.6455196],[1.520769,42.646650700000002],[1.5221905,42.648664699999998],[1.5235838,42.649570500000003],[1.525198,42.650569900000001],[1.5283562,42.651806299999997],[1.5317806,42.650825699999999],[1.5334268,42.649757100000002],[1.5362901,42.650679400000001],[1.5384266,42.6524711],[1.5417003,42.653067100000001],[1.5430017,42.653927099999997],[1.5471188,42.655027799999999],[1.5492987,42.655935700000001],[1.5502197,42.655162599999997],[1.5519598,42.6545092],[1.5526267,42.654271000000001],[1.5558665,42.653113900000001],[1.5581418,42.652048800000003],[1.5591671,42.652804600000003],[1.5606224,42.6534695],[1.5623621,42.653330699999998],[1.5637655,42.652824099999997],[1.5653109,42.6520607],[1.5665284,42.6509663],[1.5668044,42.650105400000001],[1.5675293,42.649614800000002],[1.5684573,42.648248899999999],[1.5710843,42.647782200000002],[1.5728436,42.646939199999998],[1.5746951,42.6471436],[1.5756133,42.646374999999999],[1.576065,42.6424898],[1.5784025,42.641675399999997],[1.5800818,42.637092600000003],[1.5843433,42.633938100000002],[1.5888532,42.633695699999997],[1.5936564,42.632876899999999],[1.5969107,42.630128599999999],[1.6003844,42.625877199999998],[1.6025439,42.62556],[1.6038785,42.625768700000002],[1.6142749,42.628967600000003],[1.6195834,42.626144500000002],[1.622267,42.627573099999999],[1.6239578,42.627004700000001],[1.6264726,42.626654899999998],[1.6277024,42.6267116],[1.6338179,42.629421999999998],[1.6370988,42.630784900000002],[1.6391393,42.629053599999999],[1.6421281,42.628635600000003],[1.6456662,42.627751600000003],[1.6498178,42.627094700000001],[1.6531544,42.6263668],[1.6550893,42.624428899999998],[1.655366,42.622478700000002],[1.6596655,42.620488000000002],[1.6605662,42.620433900000002],[1.6612658,42.619818100000003],[1.66201,42.619460799999999],[1.6626009,42.619465499999997],[1.6631695,42.6190918],[1.6636103,42.619122300000001],[1.6639012,42.6189812],[1.6643992,42.619366800000002],[1.6651325,42.620478599999998],[1.6661337,42.621073199999998],[1.6676988,42.621682],[1.669353,42.621324100000002],[1.6707728,42.621471499999998],[1.6729577,42.621111300000003],[1.6746472,42.622287999999998],[1.6781595,42.6225843],[1.6798991,42.624111499999998],[1.6805985,42.624829499999997],[1.6829905,42.624958399999997],[1.6841488,42.6253089],[1.6866014,42.6245355],[1.6874736,42.623942],[1.6890226,42.623851299999998],[1.6906579,42.623317900000004],[1.6917336,42.622292799999997],[1.6925518,42.622122300000001],[1.6945117,42.622542299999999],[1.6965939,42.622385999999999],[1.6985702,42.622838100000003],[1.699972,42.622542000000003],[1.7008524,42.622324200000001],[1.7040765,42.620009500000002],[1.7054542,42.619192099999999],[1.7078756,42.618165300000001],[1.7113121,42.616188899999997],[1.7133034,42.614995800000003],[1.7154978,42.614576300000003],[1.7198288,42.615167300000003],[1.7214072,42.615855400000001],[1.7227373,42.616728299999998],[1.7302339,42.6146174],[1.7320099,42.615063900000003],[1.7332333,42.615579199999999],[1.734755,42.616257500000003],[1.7361628,42.617945800000001],[1.7361106,42.615651999999997],[1.7379897,42.612560799999997],[1.7384087,42.611709900000001],[1.7356452,42.609212599999999],[1.7338747,42.6075698],[1.732985,42.603518999999999],[1.7302129,42.600449699999999],[1.727676,42.6010001],[1.7270214,42.596844099999998],[1.7270029,42.591923100000002],[1.7263033,42.5913994],[1.7268159,42.589881900000002],[1.7268146,42.589061800000003],[1.7276538,42.588268599999999],[1.7286637,42.588169100000002],[1.7302364,42.587974000000003],[1.7316027,42.587959099999999],[1.7328924,42.588309099999996],[1.733715,42.5887995],[1.7348812,42.588146999999999],[1.7371009,42.587860599999999],[1.7419455,42.587872500000003],[1.7452022,42.586347400000001],[1.7481994,42.585081600000002],[1.7510638,42.584520500000004],[1.7537594,42.582669000000003],[1.7555043,42.5826268],[1.7600986,42.580922200000003],[1.7682962,42.580140999999998],[1.7749424,42.581435599999999],[1.7795965,42.581791600000003],[1.7824244,42.5789197],[1.7845513,42.5755421],[1.7863837,42.573972300000001],[1.7861811,42.573763499999998],[1.786061,42.573684999999998],[1.7858202,42.573586200000001],[1.7855389,42.573498200000003],[1.785358,42.573385600000002],[1.7852997,42.573281199999997],[1.785305,42.573000999999998],[1.7852328,42.572735199999997],[1.7851255,42.572507100000003],[1.7848858,42.572399099999998],[1.7834572,42.571942800000002],[1.7827192,42.571695499999997],[1.7822111,42.571372500000003],[1.78205,42.570896699999999],[1.7818231,42.570720999999999],[1.7815766,42.570602999999998],[1.7811265,42.570381900000001],[1.7806939,42.5701806],[1.7802618,42.569937600000003],[1.7800071,42.569836600000002],[1.7794124,42.569593500000003],[1.7790532,42.569461699999998],[1.7786108,42.569185300000001],[1.7779664,42.5688137],[1.7776234,42.5686544],[1.7770523,42.568463100000002],[1.7769281,42.568362999999998],[1.7766724,42.5681358],[1.7764412,42.568052600000001],[1.7761073,42.567931999999999],[1.775924,42.567946900000003],[1.7755819,42.567981199999998],[1.7754753,42.567951200000003],[1.7754078,42.567912800000002],[1.7752809,42.567796899999998],[1.7751123,42.567653700000001],[1.7750546,42.567532100000001],[1.7749147,42.567247000000002],[1.7746708,42.567059999999998],[1.7743478,42.566876000000001],[1.7739277,42.566685900000003],[1.7736509,42.566487199999997],[1.7733932,42.566416799999999],[1.77299,42.566348599999998],[1.7726213,42.566372399999999],[1.7722065,42.566267000000003],[1.7720414,42.566254600000001],[1.7714573,42.566332500000001],[1.7713033,42.566349899999999],[1.7712238,42.566281400000001],[1.7712931,42.566087699999997],[1.7713013,42.566005500000003],[1.7712303,42.565914900000003],[1.7711143,42.565851500000001],[1.7707598,42.565848699999997],[1.7706354,42.565803299999999],[1.7702048,42.565455900000003],[1.7700908,42.5653018],[1.7699937,42.565124900000001],[1.7698052,42.564966300000002],[1.7696872,42.564922199999998],[1.7683621,42.564737999999998],[1.7638304,42.565394499999996],[1.7580984,42.564635799999998],[1.7532069,42.564258600000002],[1.7499655,42.563655099999998],[1.7481698,42.563067500000002],[1.7454544,42.561033299999998],[1.7434364,42.559060600000002],[1.7416814,42.557684600000002],[1.7401241,42.5564982],[1.7389233,42.555160600000001],[1.7371331,42.551969300000003],[1.7356673,42.5498969],[1.735449,42.548799899999999],[1.7361591,42.544826200000003],[1.7353493,42.544163300000001],[1.7356704,42.543372699999999],[1.735176,42.542215599999999],[1.7346426,42.542059199999997],[1.7343382,42.541563199999999],[1.7342972,42.5408513],[1.7345272,42.540457000000004],[1.7340424,42.5394589],[1.7335301,42.538544100000003],[1.7338764,42.537891199999997],[1.7338506,42.5373436],[1.73438,42.5367885],[1.7344317,42.536063900000002],[1.7342688,42.534981199999997],[1.7346792,42.533904900000003],[1.7342656,42.532633400000002],[1.7335115,42.532195199999997],[1.7334065,42.530087000000002],[1.7330199,42.528180800000001],[1.7315083,42.524914000000003],[1.7314922,42.524182199999998],[1.7322484,42.5233834],[1.7321102,42.522902999999999],[1.7309879,42.521700099999997],[1.7302319,42.520681699999997],[1.7280157,42.519614500000003],[1.7274093,42.5185131],[1.7257478,42.518700099999997],[1.7239264,42.518457300000001],[1.7224747,42.518218599999997],[1.7260662,42.515573799999999],[1.7264829,42.512630700000003],[1.7261687,42.510618700000002],[1.7256731,42.5082624],[1.7258121,42.5053391],[1.7258804,42.504181899999999],[1.7204549,42.502830400000001],[1.7201802,42.500406900000002],[1.7179555,42.497747099999998],[1.7143786,42.494680199999998],[1.7113736,42.492255900000004],[1.7093993,42.491562899999998],[1.7074028,42.491059800000002],[1.7061151,42.490437499999999],[1.7036101,42.4898022],[1.7031122,42.489813599999998],[1.7025732,42.489925800000002],[1.7021602,42.490095799999999],[1.7005904,42.491060699999998],[1.6993137,42.491554299999997],[1.693689,42.493603700000001],[1.6924257,42.494114699999997],[1.6909338,42.494824100000002],[1.6904217,42.494971200000002],[1.688403,42.495143900000002],[1.6865979,42.495406899999999],[1.6859881,42.495548900000003],[1.6856592,42.495544299999999],[1.6825412,42.494519400000001],[1.6818095,42.4943332],[1.6811822,42.494241799999998],[1.6798649,42.494520799999997],[1.6794754,42.494680799999998],[1.6769305,42.496603499999999],[1.6759659,42.497534299999998],[1.6739522,42.500056499999999],[1.673011,42.501301400000003],[1.6721905,42.502208199999998],[1.6716895,42.502994000000001],[1.6690951,42.505791799999997],[1.6691545,42.504196399999998],[1.6689511,42.503461700000003],[1.6687722,42.502798800000001],[1.6677171,42.499815599999998],[1.6660539,42.498722000000001],[1.6658788,42.498494999999998],[1.6658103,42.498065599999997],[1.6657896,42.496481799999998],[1.6654268,42.495857299999997],[1.6637159,42.494614400000003],[1.6622391,42.493712100000003],[1.6623289,42.493138399999999],[1.6623587,42.492885100000002],[1.6625864,42.492343699999999],[1.6628134,42.491804100000003],[1.6622532,42.490161200000003],[1.6623212,42.489114000000001],[1.6625989,42.487779199999999],[1.6618271,42.484110100000002],[1.6619331,42.4837366],[1.6632892,42.481529500000001],[1.663237,42.479847999999997],[1.6608522,42.4790177],[1.6615168,42.477325],[1.6619185,42.4768404],[1.6626832,42.475512700000003],[1.6623961,42.474775899999997],[1.6624963,42.473980699999998],[1.6618527,42.473340700000001],[1.6602072,42.472309199999998],[1.6591725,42.471477899999996],[1.6588138,42.471069399999998],[1.6577557,42.469104600000001],[1.6574381,42.468757400000001],[1.6570261,42.468449999999997],[1.6565443,42.468231899999999],[1.6535853,42.4673114],[1.6509076,42.467114100000003],[1.6495996,42.467185200000003],[1.6487246,42.4673558],[1.6467199,42.468647300000001],[1.6461908,42.468689099999999],[1.6457538,42.468781900000003],[1.64504,42.468666800000001],[1.6436003,42.467617699999998],[1.642802,42.4671819],[1.6424297,42.4666566],[1.6405201,42.466581099999999],[1.6374633,42.467546400000003],[1.6361739,42.4680891],[1.6350459,42.467207999999999],[1.6343072,42.467084800000002],[1.632872,42.466422600000001],[1.6325243,42.465995499999998],[1.632347,42.465570499999998],[1.6319443,42.463740999999999],[1.6316418,42.463111900000001],[1.63168,42.462749500000001],[1.6312959,42.463028899999998],[1.6309395,42.463142400000002],[1.6306012,42.463336099999999],[1.6303564,42.463643099999999],[1.6298462,42.463978900000001],[1.6291495,42.464259200000001],[1.6285857,42.464362999999999],[1.6282316,42.464179199999997],[1.6275307,42.4640725],[1.6268161,42.464110400000003],[1.6254749,42.4648848],[1.6233701,42.4655281],[1.6225665,42.465677599999999],[1.6218997,42.465704500000001],[1.6205683,42.465465299999998],[1.6188683,42.4647121],[1.6170611,42.464963900000001],[1.6167075,42.465001399999998],[1.6152287,42.465101799999999],[1.6148837,42.4652958],[1.6141089,42.465292599999998],[1.6127243,42.465285100000003],[1.6122258,42.465350299999997],[1.6114617,42.4649748],[1.6105108,42.465272200000001],[1.6103055,42.4650204],[1.6097587,42.464779],[1.6092182,42.464607200000003],[1.6075063,42.464508899999998],[1.6064137,42.464371499999999],[1.6058163,42.4647462],[1.6054895,42.4647899],[1.6048018,42.465092900000002],[1.6045209,42.465170999999998],[1.6037821,42.465542900000003],[1.6017613,42.466173300000001],[1.6014045,42.466448800000002],[1.6005815,42.466833000000001],[1.6000412,42.466926700000002],[1.5987321,42.467645599999997],[1.5983346,42.467697600000001],[1.5976114,42.467618600000002],[1.5968831,42.467305699999997],[1.5960309,42.4666286],[1.5947727,42.465886699999999],[1.5922909,42.464707799999999],[1.5903367,42.463426699999999],[1.589408,42.463031700000002],[1.5881149,42.4626424],[1.5867117,42.461744299999999],[1.5861342,42.461164199999999],[1.5856715,42.460489500000001],[1.5855224,42.459118500000002],[1.58401,42.457719900000001],[1.5835823,42.457358900000003],[1.5829952,42.456977199999997],[1.5826203,42.456505999999997],[1.5825033,42.456069499999998],[1.5824974,42.4556556],[1.5818266,42.453629599999999],[1.5816352,42.452673900000001],[1.5816531,42.452087900000002],[1.581543,42.451579099999996],[1.5812111,42.450192600000001],[1.5788543,42.449885999999999],[1.5775927,42.450089599999998],[1.5765771,42.451165699999997],[1.5752643,42.451668400000003],[1.5744669,42.4520695],[1.5721767,42.454006800000002],[1.5719099,42.454350599999998],[1.5713525,42.455543400000003],[1.5710737,42.455887699999998],[1.5701828,42.456508499999998],[1.5699924,42.456732199999998],[1.5695975,42.457486299999999],[1.5684384,42.458432999999999],[1.5674495,42.458877600000001],[1.5669833,42.458986299999999],[1.5663719,42.458938699999997],[1.565925,42.458812399999999],[1.5654198,42.458553500000001],[1.563335,42.458141500000004],[1.5616602,42.458685500000001],[1.5611409,42.458655700000001],[1.5605466,42.458585800000002],[1.5601249,42.458305500000002],[1.5580818,42.4556228],[1.5574038,42.454992599999997],[1.5570583,42.454421099999998],[1.5570097,42.453918799999997],[1.557113,42.453500499999997],[1.557893,42.452857199999997],[1.5580658,42.4523911],[1.5584839,42.4521224],[1.5587553,42.451841399999999],[1.5590642,42.4507397],[1.5601644,42.4493182],[1.5601383,42.448959100000003],[1.5600057,42.448640300000001],[1.5596772,42.448302200000001],[1.5587614,42.447744499999999],[1.5581817,42.447461500000003],[1.5557849,42.446764600000002],[1.5551386,42.446403199999999],[1.5548364,42.446091099999997],[1.5530422,42.443479500000002],[1.554079,42.440179000000001],[1.5532847,42.439283199999998],[1.5533874,42.438018700000001],[1.5527231,42.4357313],[1.5532606,42.4350977],[1.5529359,42.433805100000001],[1.5526311,42.433457099999998],[1.5510875,42.4326182],[1.5503875,42.432853100000003],[1.5495621,42.432867899999998],[1.5481306,42.433239999999998],[1.546282,42.432719300000002],[1.5447555,42.432617899999997],[1.5437745,42.432665800000002],[1.5425258,42.432373300000002],[1.5413261,42.432420999999998],[1.5395466,42.433022800000003],[1.5389911,42.433071900000002],[1.5382306,42.432975999999996],[1.5361219,42.432555399999998],[1.5349743,42.432483900000001],[1.5314098,42.432436099999997],[1.5294344,42.432514400000002],[1.5257503,42.432155999999999],[1.5238409,42.431295200000001],[1.5229879,42.431094899999998],[1.5208165,42.4309826],[1.5196652,42.431028099999999],[1.518834,42.4309619],[1.5183969,42.430799100000002],[1.5170338,42.429421400000003],[1.516282,42.428937900000001],[1.5157512,42.428823800000004],[1.5128402,42.428902700000002],[1.5104309,42.429538000000001],[1.5096046,42.429876700000001],[1.5083064,42.429738800000003],[1.5073217,42.429903600000003],[1.5064272,42.430479099999999],[1.5051912,42.430698800000002],[1.5039403,42.4315584],[1.4970311,42.433000700000001],[1.4960686,42.433137600000002],[1.4946283,42.433221199999998],[1.4852027,42.433303100000003],[1.4845776,42.433399700000002],[1.4829996,42.433767600000003],[1.4823969,42.434007399999999],[1.4792335,42.434302299999999],[1.4776918,42.435011000000003],[1.4762636,42.435436000000003],[1.4727799,42.435842399999999],[1.4691654,42.436118800000003],[1.4620994,42.436403599999998],[1.4597958,42.436313400000003],[1.4578411,42.436002500000001],[1.4565441,42.435881899999998],[1.4551833,42.436061000000002],[1.4524043,42.4369795],[1.450045,42.437989700000003],[1.4472306,42.439440699999999],[1.444393,42.441423700000001],[1.4438243,42.4423192],[1.4432567,42.443916799999997],[1.4425834,42.444708300000002],[1.446796,42.443770299999997],[1.4463408,42.445237599999999],[1.4453203,42.446618800000003],[1.4455696,42.447221399999997],[1.4462107,42.448204799999999],[1.443723,42.450327399999999],[1.4417739,42.451645599999999],[1.4415964,42.452057600000003],[1.4420493,42.452787299999997],[1.4418882,42.453775],[1.4414494,42.455304699999999],[1.4418284,42.455848199999998],[1.4433023,42.457087399999999],[1.4440591,42.457472199999998],[1.4455491,42.458080600000002],[1.4461635,42.459029100000002],[1.4468565,42.459542399999997],[1.4474698,42.460130800000002],[1.4472227,42.460590500000002],[1.4445177,42.4618842],[1.4429258,42.462927399999998],[1.4405053,42.463777700000001],[1.4401216,42.464368899999997],[1.4405942,42.465890199999997],[1.4406748,42.4675437],[1.4405333,42.469664999999999],[1.4402156,42.47119],[1.440403,42.472461199999998],[1.4412336,42.474571900000001],[1.4412514,42.474994299999999],[1.4410304,42.475480099999999],[1.4398064,42.476572099999998],[1.4338041,42.480955600000001],[1.4333876,42.481773099999998],[1.4312771,42.482439200000002],[1.4283583,42.482280600000003],[1.426182,42.482395699999998],[1.4233179,42.482554100000002],[1.4202306,42.482751700000001],[1.4174244,42.482388200000003],[1.4191502,42.484277900000002],[1.4209885,42.486340200000001],[1.4220951,42.487946600000001],[1.4235121,42.489718500000002],[1.4235189,42.490221099999999],[1.4237358,42.490925599999997],[1.4250765,42.492331900000003],[1.4262655,42.4930077],[1.4316232,42.4923486],[1.4352648,42.493315299999999],[1.4410755,42.494818199999997],[1.4438432,42.495599800000001],[1.4519768,42.499929100000003],[1.4535079,42.501226299999999],[1.4554275,42.5024254],[1.4564299,42.502990500000003],[1.4577898,42.503504700000001],[1.4590065,42.504015500000001],[1.4603314,42.504474399999999],[1.4607144,42.505272499999997],[1.4614809,42.505911599999997],[1.46249,42.506625800000002],[1.4668285,42.509445700000001],[1.4683974,42.509995600000003],[1.4675276,42.511530999999998],[1.4666241,42.512898100000001],[1.4658019,42.514182599999998],[1.4633294,42.519171299999996],[1.4602687,42.522415100000003],[1.4600349,42.522892400000003],[1.4599545,42.523471800000003],[1.4575136,42.525601799999997],[1.4567898,42.526035200000003],[1.4551062,42.526429899999997],[1.4548047,42.527186499999999],[1.454921,42.528164799999999],[1.4545929,42.530182699999997],[1.4546243,42.530463699999999],[1.4539813,42.531284499999998],[1.4526453,42.533104399999999],[1.452541,42.534080600000003],[1.4522456,42.536413500000002],[1.4526245,42.537461100000002],[1.4526603,42.537792899999999],[1.4525421,42.538184700000002],[1.4525271,42.5387141],[1.451969,42.539453899999998],[1.450724,42.540076999999997],[1.4469326,42.541500200000002],[1.444061,42.542579000000003],[1.4429108,42.543151199999997],[1.4418183,42.543463799999998],[1.4406666,42.5435984],[1.4396504,42.543691899999999],[1.4386509,42.543676699999999],[1.4373,42.543341900000001],[1.4367728,42.543119300000001],[1.4362744,42.542787500000003],[1.4351812,42.541794400000001],[1.4343001,42.541216300000002],[1.4326473,42.540079400000003],[1.4310123,42.5396036],[1.429138,42.539285700000001],[1.4264438,42.539278699999997],[1.4253863,42.5391306],[1.425016,42.539004400000003],[1.4210093,42.536960499999999],[1.4177839,42.535806999999998],[1.4161534,42.535624900000002],[1.4135847,42.535374699999998]]]]});

	return Cliche.extend({
		jade: jade,
		create: function () {
			this.destroy = _.wrap(this.destroy, this.localDestroy);
			this.auth = globalVM.repository['m/common/auth'];
			this.createMode = ko.observable(true);

			this.region = ko_mapping.fromJS(regionDef);
			this.geoStringOrigin = null;
			this.geoObj = null;

			this.map = null;
			this.layerSaved = null;
			this.layerCurr = null;

			this.subscriptions.route = globalVM.router.routeChanged.subscribe(this.routeHandler, this);

			ko.applyBindings(globalVM, this.$dom[0]);
			this.show(function () {
				this.routeHandler();
			}, this);
		},
		show: function (cb, ctx) {
			globalVM.func.showContainer(this.$container, function () {
				this.map = new L.map(this.$dom.find('.map')[0], {center: [42.536892, 1.573791], zoom: 9, minZoom: 3, maxZoom: 13, trackResize: true});

				L.tileLayer('http://{s}.tile.osmosnimki.ru/kosmo/{z}/{x}/{y}.png', {
					maxZoom: 16
				}).addTo(this.map);

				this.map.whenReady(function () {
					cb.call(ctx);
				});
			}, this);
			this.showing = true;
		},
		hide: function () {
			globalVM.func.hideContainer(this.$container);
			this.showing = false;
		},
		localDestroy: function (destroy) {
			this.map.remove();
			delete this.map;

			this.hide();
			destroy.call(this);
		},
		routeHandler: function () {
			var cid = Number(globalVM.router.params().cid);

			this.createMode(!cid);
			if (this.createMode()) {
				this.resetData();
			} else {
				this.getOneRegion(cid, function (data, error) {
					if (!error) {
						this.fillData();
					}
				}, this);
			}
		},
		resetData: function () {
			if (this.layerSaved) {
				this.map.removeLayer(this.layerSaved);
			}
			ko_mapping.fromJS(regionDef, this.region);
		},
		fillData: function () {
			if (this.layerSaved) {
				this.map.removeLayer(this.layerSaved);
			}
			this.layerSaved = L.geoJson(this.geoObj, {
				style: {
					"color": "#F00",
					"weight": 3,
					"opacity": 0.6
				}
			}).addTo(this.map);
		},
		getOneRegion: function (cid, cb, ctx) {
			socket.once('takeRegion', function (data) {
				var error = !data || !!data.error || !data.region;

				if (error) {
					window.noty({text: data && data.message || 'Error occurred', type: 'error', layout: 'center', timeout: 3000, force: true});
				} else {
					ko_mapping.fromJS(data.region, this.region);
					this.geoStringOrigin = data.region.geo;
					try {
						this.geoObj = JSON.parse(data.region.geo);
					} catch (err) {
						window.noty({text: 'GeoJSON client parse error!', type: 'error', layout: 'center', timeout: 3000, force: true});
						this.geoObj = null;
						error = true;
					}
				}

				if (Utils.isType('function', cb)) {
					cb.call(ctx, data, error);
				}
			}.bind(this));
			socket.emit('giveRegion', {cid: cid});
		},
		save: function () {
			var saveData = ko_mapping.toJS(this.region);

			if (!saveData.title_en) {
				window.noty({text: 'Нужно заполнить английское название', type: 'error', layout: 'center', timeout: 2000, force: true});
				return false;
			}
			if (!saveData.geo) {
				window.noty({text: 'GeoJSON обязателен!', type: 'error', layout: 'center', timeout: 2000, force: true});
				return false;
			}
			if (saveData.level) {
				saveData.parent = Number(saveData.parent);
				if (!saveData.parent) {
					window.noty({text: 'Если уровень региона ниже Страны, необходимо указать номер родительского региона!', type: 'error', layout: 'center', timeout: 5000, force: true});
					return false;
				}
			} else if (saveData.parent !== undefined) {
				delete saveData.parent;
			}

			socket.once('saveRegionResult', function (data) {
				if (!data || data.error || !data.region) {
					window.noty({text: data && data.message || 'Error occurred', type: 'error', layout: 'center', timeout: 3000, force: true});
				} else {
					window.noty({text: 'Сохранено', type: 'success', layout: 'center', timeout: 1800, force: true});
					if (this.createMode()) {
						globalVM.router.navigateToUrl('/admin/region/' + data.region.cid);
					}
				}
			}.bind(this));
			socket.emit('saveRegion', saveData);
			return false;
		}
	});
});